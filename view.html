<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Map View</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 500px; width: 800px; }
        .custom-icon { background-color: transparent; border-radius: 50%; width: 40px; height: 40px; overflow: hidden; border: 2px solid #000; }
        .custom-icon-img { width: 100%; height: 100%; object-fit: cover; }
        .text-label { font-size: 16px; text-align: center; }
    </style>
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/dom-to-image@2.6.0/dist/dom-to-image.min.js"></script>
</head>
<body>
    <script>
        const formatDistance = (distance, distanceUnit = 'metric') => {
            const SMALL_UNIT = distanceUnit === 'imperial' ? 'yd' : 'm';
            const LARGE_UNIT = distanceUnit === 'imperial' ? 'miles' : 'km';
            const UNIT_MULTIPLIER = distanceUnit === 'imperial' ? 1760 : 1000;
        
            if (distance < 1) {
                return `${Math.round(distance * UNIT_MULTIPLIER)} ${SMALL_UNIT}`;
            };
        
            return `${module.exports.formatLargeNumber(Math.round(distance))} ${LARGE_UNIT}`;
        };
        
        // Get latitude and longitude from URI components
        var urlParams = new URLSearchParams(window.location.search);
        var lat1 = parseFloat(urlParams.get('lat1')) || 0;
        var lon1 = parseFloat(urlParams.get('lon1')) || 0;
        var lat2 = parseFloat(urlParams.get('lat2')) || 0;
        var lon2 = parseFloat(urlParams.get('lon2')) || 0;
        var iconUrl = urlParams.get('icon');
        var units = urlParams.get('units') || 'metric';
        const width = parseFloar(urlParams.get('width')) || 800;
        const height = parseFloar(urlParams.get('height')) || 500;

        const mapElement = document.createElement("div");
        mapElement.style.width = `${width}px`;
        mapElement.style.height = `${height}px`;
        document.body.appendChild(mapElement);

        // Create Leaflet map with a default center and zoom level
        const map = L.map(mapElement, {
            attributionControl: false,
            zoomControl: false,
            fadeAnimation: false,
            zoomAnimation: false
        }).setView([0, 0], 2); // Adjusted zoom level

        // Add a default base layer (OpenStreetMap)
        const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap Developers'
        }).addTo(map);

        var customIcon = iconUrl ? L.divIcon({
            className: 'custom-icon',
            html: '<img src="' + iconUrl + '" class="custom-icon-img"/>',
            iconSize: [40, 40],
            iconAnchor: [20, 20],
        }) : L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
        });

        var marker1 = L.marker([lat1, lon1], { icon: customIcon }).addTo(map);
        var marker2 = L.marker([lat2, lon2]).addTo(map);

        // Add a dashed polyline to connect the two points
        var polyline = L.polyline([[lat1, lon1], [lat2, lon2]], {
            color: 'red',
            dashArray: '10, 5' // Adjusted the dash pattern as needed
        }).addTo(map);

        // Calculate the distance between the two points
        var distance = marker1.getLatLng().distanceTo(marker2.getLatLng());

        // Display the distance as a text label on the map
        var textLabel = L.divIcon({
            className: 'text-label',
            html: '<div>' + formatDistance(distance / 1000, units) + '</div>'
        });

        var distanceMarker = L.marker(polyline.getBounds().getCenter(), { icon: textLabel }).addTo(map);

        // Fit the map to the bounds of both points with a bit less padding
        var bounds = L.latLngBounds([[lat1, lon1], [lat2, lon2]]);
        map.fitBounds(bounds.pad(0.05));
    </script>
</body>
</html>
